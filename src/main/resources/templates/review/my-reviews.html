<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <header th:replace="~{fragments/base :: head}"></header>
  <style>
    .rating {
      color: #ffc107;
    }
    .review-card {
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
    }
    .star-rating {
      display: inline-block;
      font-size: 20px;
    }
    .star-rating-input {
      font-size: 30px;
      cursor: pointer;
      user-select: none;
    }
    .star-input {
      color: #ddd;
      transition: color 0.2s;
    }
    .star-input:hover,
    .star-input.active {
      color: #ffc107;
    }
  </style>
</head>
<body>
<div th:insert="~{fragments/base :: top}"></div>

<div class="container" style="margin-top:80px">
  <div class="row">
    <div class="col-3">
      <aside th:replace="~{fragments/base :: aside('/img/review.png')}"></aside>
    </div>

    <div class="col-9">
      <main>
        <h3><strong>내가 작성한 리뷰</strong></h3>
        <hr>

        <!-- 리뷰 목록 -->
        <div th:if="${reviews.isEmpty()}" class="alert alert-info">
          작성한 리뷰가 없습니다.
        </div>

        <div th:each="review : ${reviews}" class="review-card">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <a th:href="@{/view/books/detail/{id}(id=${review.bookId})}" style="font-size: 1.2rem; font-weight: bold;">
                [[${review.bookTitle}]]
              </a>
              <div class="star-rating mt-1">
                <span th:each="i : ${#numbers.sequence(1, 5)}">
                  <i th:class="${i <= review.rating ? 'fas fa-star rating' : 'far fa-star'}"></i>
                </span>
              </div>
            </div>
            <small class="text-muted" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01 12:00</small>
          </div>
          <p th:text="${review.content}">리뷰 내용입니다.</p>
          <div th:if="${review.updatedAt != null && review.updatedAt != review.createdAt}">
            <small class="text-muted">(수정됨: [[${#temporals.format(review.updatedAt, 'yyyy-MM-dd HH:mm')}]])</small>
          </div>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-primary"
                    th:attr="data-review-id=${review.id}, data-rating=${review.rating}, data-content=${review.content}"
                    onclick="editReviewByData(this)">
              <i class="fas fa-edit"></i> 수정
            </button>
            <button class="btn btn-sm btn-outline-danger"
                    th:onclick="|deleteReview(${review.id})|">
              <i class="fas fa-trash"></i> 삭제
            </button>
          </div>
        </div>

      </main>
    </div>
  </div>
</div>

<!-- 리뷰 수정 모달 -->
<div class="modal fade" id="editReviewModal" tabindex="-1" aria-labelledby="editReviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="editReviewModalLabel"><i class="fas fa-edit"></i> 리뷰 수정</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editReviewForm">
          <input type="hidden" id="editReviewId">

          <div class="mb-3">
            <label class="form-label">평점 *</label>
            <div class="star-rating-input">
              <span class="star-input" data-value="1">☆</span>
              <span class="star-input" data-value="2">☆</span>
              <span class="star-input" data-value="3">☆</span>
              <span class="star-input" data-value="4">☆</span>
              <span class="star-input" data-value="5">☆</span>
              <input type="hidden" id="editRating" name="rating" value="0">
            </div>
            <small class="text-muted">별을 클릭하여 평점을 선택하세요</small>
          </div>

          <div class="mb-3">
            <label for="editContent" class="form-label">리뷰 내용 *</label>
            <textarea class="form-control" id="editContent" name="content" rows="5"
                      placeholder="리뷰 내용을 입력하세요" required></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> 취소
        </button>
        <button type="button" class="btn btn-primary" onclick="submitEditReview()">
          <i class="fas fa-check"></i> 수정 완료
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let editModal;

  document.addEventListener('DOMContentLoaded', function() {
    // 모달 초기화
    editModal = new bootstrap.Modal(document.getElementById('editReviewModal'));

    // 별점 선택 이벤트
    const stars = document.querySelectorAll('.star-input');
    const ratingInput = document.getElementById('editRating');

    stars.forEach((star) => {
      star.addEventListener('click', function() {
        const value = parseInt(this.getAttribute('data-value'));
        ratingInput.value = value;

        // 모든 별 초기화
        stars.forEach(s => {
          s.classList.remove('active');
          s.textContent = '☆';
        });

        // 선택된 별까지 채우기
        for (let i = 0; i < value; i++) {
          stars[i].classList.add('active');
          stars[i].textContent = '★';
        }
      });

      star.addEventListener('mouseenter', function() {
        const value = parseInt(this.getAttribute('data-value'));
        for (let i = 0; i < value; i++) {
          stars[i].textContent = '★';
        }
      });
    });

    const starContainer = document.querySelector('.star-rating-input');
    starContainer.addEventListener('mouseleave', function() {
      const currentValue = parseInt(ratingInput.value);
      stars.forEach((s, i) => {
        if (i < currentValue) {
          s.textContent = '★';
        } else {
          s.textContent = '☆';
        }
      });
    });
  });

  function editReviewByData(button) {
    const reviewId = button.getAttribute('data-review-id');
    const currentRating = parseInt(button.getAttribute('data-rating'));
    const currentContent = button.getAttribute('data-content');
    editReview(reviewId, currentRating, currentContent);
  }

  function editReview(reviewId, currentRating, currentContent) {
    // 모달에 현재 값 설정
    document.getElementById('editReviewId').value = reviewId;
    document.getElementById('editRating').value = currentRating;
    document.getElementById('editContent').value = currentContent;

    // 별점 표시
    const stars = document.querySelectorAll('.star-input');
    stars.forEach((s, i) => {
      if (i < currentRating) {
        s.classList.add('active');
        s.textContent = '★';
      } else {
        s.classList.remove('active');
        s.textContent = '☆';
      }
    });

    // 모달 표시
    editModal.show();
  }

  function submitEditReview() {
    const reviewId = document.getElementById('editReviewId').value;
    const rating = parseInt(document.getElementById('editRating').value);
    const content = document.getElementById('editContent').value.trim();

    // 유효성 검사
    if (rating === 0) {
      alert('별점을 선택해주세요.');
      return;
    }

    if (!content) {
      alert('리뷰 내용을 입력해주세요.');
      return;
    }

    // AJAX 요청
    fetch('/api/reviews/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        id: parseInt(reviewId),
        rating: rating,
        content: content
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error('리뷰 수정에 실패했습니다.');
      }
      return response.json();
    })
    .then(data => {
      alert('리뷰가 수정되었습니다.');
      editModal.hide();
      location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('리뷰 수정 중 오류가 발생했습니다: ' + error.message);
    });
  }

  function deleteReview(reviewId) {
    if (confirm('정말 이 리뷰를 삭제하시겠습니까?\n삭제된 리뷰는 복구할 수 없습니다.')) {
      fetch('/api/reviews/delete?id=' + reviewId, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('리뷰 삭제에 실패했습니다.');
        }
        return response.json();
      })
      .then(data => {
        alert('리뷰가 삭제되었습니다.');
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
        alert('리뷰 삭제 중 오류가 발생했습니다: ' + error.message);
      });
    }
  }
</script>
</body>
</html>
