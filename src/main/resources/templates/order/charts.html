<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µê³„ ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }
        .chart-wrapper {
            position: relative;
            height: 400px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .controls button:hover {
            background-color: #45a049;
        }
        .controls button.active {
            background-color: #2196F3;
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š OnBok í†µê³„ ëŒ€ì‹œë³´ë“œ</h1>

        <div class="controls">
            <button onclick="loadDailySales(7)" class="active" id="btn7">ìµœê·¼ 7ì¼</button>
            <button onclick="loadDailySales(14)" id="btn14">ìµœê·¼ 14ì¼</button>
            <button onclick="loadDailySales(30)" id="btn30">ìµœê·¼ 30ì¼</button>
        </div>

        <div class="grid">
            <div class="chart-container">
                <div class="chart-title">ì¼ë³„ ë§¤ì¶œ ì¶”ì´</div>
                <div class="chart-wrapper">
                    <canvas id="dailySalesChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-title">ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ ë¹„ìœ¨</div>
                <div class="chart-wrapper">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <div class="chart-title">ì¼ë³„ ì£¼ë¬¸ ê±´ìˆ˜</div>
            <div class="chart-wrapper">
                <canvas id="orderCountChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let dailySalesChart, orderCountChart, categoryChart;

        // ì¼ë³„ ë§¤ì¶œ ì°¨íŠ¸ ë¡œë“œ
        async function loadDailySales(days) {
            // ë²„íŠ¼ í™œì„±í™” í‘œì‹œ
            document.querySelectorAll('.controls button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn${days}`).classList.add('active');

            try {
                const response = await fetch(`/api/orders/chart/daily-sales?days=${days}`);
                const result = await response.json();
                const data = result.data;

                // ë§¤ì¶œ ì°¨íŠ¸
                const ctx1 = document.getElementById('dailySalesChart');
                if (dailySalesChart) dailySalesChart.destroy();
                dailySalesChart = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'ì¼ë³„ ë§¤ì¶œ (ì›)',
                            data: data.salesData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + 'ì›';
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value.toLocaleString() + 'ì›';
                                    }
                                }
                            }
                        }
                    }
                });

                // ì£¼ë¬¸ ê±´ìˆ˜ ì°¨íŠ¸
                const ctx2 = document.getElementById('orderCountChart');
                if (orderCountChart) orderCountChart.destroy();
                orderCountChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'ì£¼ë¬¸ ê±´ìˆ˜',
                            data: data.orderCountData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì¼ë³„ ë§¤ì¶œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ ì°¨íŠ¸ ë¡œë“œ
        async function loadCategorySales() {
            try {
                const response = await fetch('/api/orders/chart/category-sales?days=30');
                const result = await response.json();
                const data = result.data;

                const ctx = document.getElementById('categoryChart');
                if (categoryChart) categoryChart.destroy();
                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.labels,
                        datasets: [{
                            label: 'íŒë§¤ ìˆ˜ëŸ‰',
                            data: data.data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)',
                                'rgba(255, 159, 64, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return label + ': ' + value + 'ê¶Œ (' + percentage + '%)';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ë³„ íŒë§¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ˆê¸° ë¡œë“œ
        window.onload = function() {
            loadDailySales(7);
            loadCategorySales();
        };
    </script>
</body>
</html>
