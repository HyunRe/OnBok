<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <header th:replace="~{fragments/base :: head}"></header>
  <style>
    th { text-align: center; }
    td { vertical-align: middle; }
    .status-badge {
      padding: 5px 10px;
      border-radius: 5px;
      font-weight: bold;
    }
    .status-PENDING { background-color: #ffc107; color: #000; }
    .status-PAYMENT_COMPLETED { background-color: #28a745; color: #fff; }
    .status-PREPARING { background-color: #17a2b8; color: #fff; }
    .status-SHIPPED { background-color: #007bff; color: #fff; }
    .status-DELIVERED { background-color: #6c757d; color: #fff; }
    .status-CANCELLED { background-color: #dc3545; color: #fff; }
    .status-REFUNDED { background-color: #6610f2; color: #fff; }
  </style>
  <script>
    function confirmCancel() {
      return confirm('정말 주문을 취소하시겠습니까? 재고가 복구됩니다.');
    }
    function confirmRefund() {
      return confirm('정말 환불하시겠습니까? 재고가 복구됩니다.');
    }
  </script>
</head>
<body>
<div th:insert="~{fragments/base :: top}"></div>

<div class="container" style="margin-top:80px">
  <div class="row">
    <div class="col-3">
      <aside th:replace="~{fragments/base :: aside('/img/shopping.png')}"></aside>
    </div>

    <div class="col-9">
      <main>
        <h3><strong>주문 상세</strong></h3>
        <hr>

        <!-- 알림 메시지 -->
        <div th:if="${msg}" class="alert alert-info alert-dismissible fade show" role="alert">
          [[${msg}]]
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- 주문 정보 -->
        <div class="card mb-3">
          <div class="card-header">
            <h5>주문 정보</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless">
              <tr>
                <th style="width: 20%">주문번호</th>
                <td th:text="${order.id}">1</td>
              </tr>
              <tr>
                <th>주문 시간</th>
                <td th:text="${#temporals.format(order.orderDateTime, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:00:00</td>
              </tr>
              <tr>
                <th>주문 상태</th>
                <td>
                  <span class="status-badge" th:classappend="'status-' + ${order.status}" th:text="${order.status.description}">주문 대기</span>
                </td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 주문 상품 목록 -->
        <div class="card mb-3">
          <div class="card-header">
            <h5>주문 상품</h5>
          </div>
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th style="width: 10%">이미지</th>
                  <th style="width: 40%">상품명</th>
                  <th style="width: 15%">단가</th>
                  <th style="width: 15%">수량</th>
                  <th style="width: 20%">소계</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="item : ${order.orderItems}">
                  <td style="text-align: center;">
                    <img th:src="${item.book.imageUrl}" height="60" alt="Book Image">
                  </td>
                  <td>
                    <a th:href="@{/view/books/detail/{id}(id=${item.book.id})}" th:text="${item.book.title}">책 제목</a>
                  </td>
                  <td style="text-align: right;" th:text="|${#numbers.formatInteger(item.book.price, 0, 'COMMA')}원|">15,000원</td>
                  <td style="text-align: center;" th:text="${item.quantity}">1</td>
                  <td style="text-align: right;" th:text="|${#numbers.formatInteger(item.subPrice, 0, 'COMMA')}원|">15,000원</td>
                </tr>
              </tbody>
              <tfoot>
                <tr>
                  <th colspan="4" style="text-align: right;">총 금액</th>
                  <th style="text-align: right;" th:text="|${#numbers.formatInteger(order.totalAmount, 0, 'COMMA')}원|">30,000원</th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- 배송 정보 -->
        <div class="card mb-3">
          <div class="card-header">
            <h5>배송 정보</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless">
              <tr>
                <th style="width: 20%">수령인</th>
                <td th:text="${order.deliveryAddress.receiverName}">홍길동</td>
              </tr>
              <tr>
                <th>연락처</th>
                <td th:text="${order.deliveryAddress.receiverPhone}">010-1234-5678</td>
              </tr>
              <tr>
                <th>배송지 주소</th>
                <td>
                  <span th:text="${order.deliveryAddress.zipCode}">12345</span><br>
                  <span th:text="${order.deliveryAddress.address}">서울시 강남구</span>
                  <span th:text="${order.deliveryAddress.detailAddress}">상세주소</span>
                </td>
              </tr>
              <tr th:if="${order.deliveryAddress.message}">
                <th>배송 메모</th>
                <td th:text="${order.deliveryAddress.message}">문 앞에 놔주세요</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 결제 정보 -->
        <div class="card mb-3">
          <div class="card-header">
            <h5>결제 정보</h5>
          </div>
          <div class="card-body">
            <table class="table table-borderless">
              <tr>
                <th style="width: 20%">결제 금액</th>
                <td th:text="|${#numbers.formatInteger(order.tossPayment.totalPayment, 0, 'COMMA')}원|">30,000원</td>
              </tr>
              <tr>
                <th>결제 방법</th>
                <td th:text="${order.tossPayment.method}">카드</td>
              </tr>
              <tr th:if="${order.tossPayment.cardNumber}">
                <th>카드 정보</th>
                <td th:text="${order.tossPayment.cardNumber}">1234-****-****-5678</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- 액션 버튼 -->
        <div class="text-end mb-3">
          <a href="/view/orders/list" class="btn btn-secondary">목록으로</a>

          <!-- 취소 버튼 (PENDING, PAYMENT_COMPLETED, PREPARING 상태에서만 표시) -->
          <form th:if="${order.status.name() == 'PENDING' || order.status.name() == 'PAYMENT_COMPLETED' || order.status.name() == 'PREPARING'}"
                th:action="@{/view/orders/cancel/{id}(id=${order.id})}"
                method="post"
                style="display: inline;"
                onsubmit="return confirmCancel()">
            <button type="submit" class="btn btn-danger">주문 취소</button>
          </form>

          <!-- 환불 버튼 (DELIVERED 상태에서만 표시) -->
          <form th:if="${order.status.name() == 'DELIVERED'}"
                th:action="@{/view/orders/refund/{id}(id=${order.id})}"
                method="post"
                style="display: inline;"
                onsubmit="return confirmRefund()">
            <button type="submit" class="btn btn-warning">환불 요청</button>
          </form>
        </div>

      </main>
    </div>
  </div>
</div>
</body>
</html>
