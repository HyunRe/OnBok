<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <header th:replace="~{fragments/base :: head}"></header>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
</head>
<body>
<div th:insert="~{fragments/base :: top}"></div>

<div class="container" style="margin-top:80px">
    <div class="row">
        <div class="col-3">
            <aside th:replace="~{fragments/base :: aside('/img/delivery.png')}"></aside>
        </div>

        <div class="col-9">
            <main>
                <h3><strong th:text="${address != null ? '배송지 수정' : '새 배송지 등록'}">배송지 등록</strong></h3>
                <hr>

                <form id="addressForm">
                    <input type="hidden" id="addressId" th:value="${address?.id}">

                    <div class="mb-3">
                        <label for="alias" class="form-label">배송지 이름 *</label>
                        <input type="text" class="form-control" id="alias" 
                               th:value="${address?.alias}" 
                               placeholder="예: 집, 회사, 우리집 등" required>
                        <small class="text-muted">배송지를 구분할 수 있는 이름을 입력하세요</small>
                    </div>

                    <div class="mb-3">
                        <label for="recipientName" class="form-label">받는 분 *</label>
                        <input type="text" class="form-control" id="recipientName" 
                               th:value="${address?.recipientName}" required>
                    </div>

                    <div class="mb-3">
                        <label for="tel" class="form-label">연락처 *</label>
                        <input type="text" class="form-control" id="tel" 
                               th:value="${address?.tel}"
                               placeholder="숫자만 입력하세요" maxlength="13" required>
                    </div>

                    <div class="mb-3">
                        <label for="zipCode" class="form-label">우편번호 *</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="zipCode" 
                                   th:value="${address?.zipCode}" readonly required>
                            <button type="button" class="btn btn-secondary" onclick="openPostcodePopup()">
                                우편번호 찾기
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="basicAddress" class="form-label">기본 주소 *</label>
                        <input type="text" class="form-control" id="basicAddress" 
                               th:value="${address?.basicAddress}" readonly required>
                    </div>

                    <div class="mb-3">
                        <label for="detailAddress" class="form-label">상세 주소 *</label>
                        <input type="text" class="form-control" id="detailAddress" 
                               th:value="${address?.detailAddress}" 
                               placeholder="동, 호수 등" required>
                    </div>

                    <div class="mb-3">
                        <label for="memo" class="form-label">배송 메모</label>
                        <select class="form-control" id="memo" th:value="${address?.memo}">
                            <option value="">선택 안함</option>
                            <option value="문앞에 놓아주세요." th:selected="${address?.memo == '문앞에 놓아주세요.'}">문앞에 놓아주세요.</option>
                            <option value="부재시 연락 부탁드려요." th:selected="${address?.memo == '부재시 연락 부탁드려요.'}">부재시 연락 부탁드려요.</option>
                            <option value="배송전 미리 연락해주세요." th:selected="${address?.memo == '배송전 미리 연락해주세요.'}">배송전 미리 연락해주세요.</option>
                            <option value="1층 택배 보관장소에 맡겨주세요." th:selected="${address?.memo == '1층 택배 보관장소에 맡겨주세요.'}">1층 택배 보관장소에 맡겨주세요.</option>
                        </select>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-secondary" onclick="location.href='/view/delivery-addresses'">
                            <i class="fas fa-arrow-left"></i> 목록으로
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> <span th:text="${address != null ? '수정' : '등록'}">등록</span>
                        </button>
                    </div>
                </form>
            </main>
        </div>
    </div>
</div>

<script>
function openPostcodePopup() {
    new daum.Postcode({
        oncomplete: function(data) {
            const address = data.roadAddress ? data.roadAddress : data.jibunAddress;
            document.getElementById('zipCode').value = data.zonecode;
            document.getElementById('basicAddress').value = address;
            document.getElementById('detailAddress').focus();
        }
    }).open();
}

// 전화번호 자동 포맷
document.getElementById('tel').addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9]/g, '');
    if (value.length <= 10) {
        value = value.replace(/(\d{3})(\d{3})(\d{1,4})/, '$1-$2-$3');
    } else {
        value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
    }
    e.target.value = value;
});

// 폼 제출
document.getElementById('addressForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const addressId = document.getElementById('addressId').value;
    const isEdit = addressId && addressId !== '';

    const data = {
        alias: document.getElementById('alias').value.trim(),
        recipientName: document.getElementById('recipientName').value.trim(),
        tel: document.getElementById('tel').value.trim(),
        zipCode: document.getElementById('zipCode').value.trim(),
        basicAddress: document.getElementById('basicAddress').value.trim(),
        detailAddress: document.getElementById('detailAddress').value.trim(),
        memo: document.getElementById('memo').value
    };

    // 유효성 검사
    if (!data.alias || !data.recipientName || !data.tel || !data.zipCode || !data.basicAddress || !data.detailAddress) {
        alert('필수 항목을 모두 입력해주세요.');
        return;
    }

    const url = isEdit ? `/api/delivery-addresses/${addressId}` : '/api/delivery-addresses';
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 200) {
            alert(result.data);
            location.href = '/view/delivery-addresses';
        } else {
            alert('실패: ' + (result.errorMessage || '알 수 없는 오류'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('처리 중 오류가 발생했습니다.');
    });
});
</script>
</body>
</html>
